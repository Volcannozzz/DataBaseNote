## 存储器层次结构

### 1. 存储技术

RAM：随机访问存储器，断电即失。主要有两类，SRAM和DRAM。

- SRAM：静态RAM，每个位存储在一个双稳态的存储器单元里。稳定，不需要刷新。CPU内的三级缓存L1，L2，L3采用的存储技术；
- DRAM：动态RAM，每个位存储为对一个电容的充电。这个电容比较小，容易漏电。因此可能需要定期对数据重写以刷新内存。主要用于主存，即内存条的存储方案。

关于DRAM：

1. DRAM芯片中的单元以二维阵列的形式进行组织，主要是为了减少引脚数量，但缺点就是，必须分两步发送地址，因而增加了访问时间。

2. DRAM芯片包装在存储器模块中，插到主板的扩展槽上，常见的包装有168个引脚的双列直插存储器模块（DIMM），以64位为块传送数据（存储控制器到存储器；存储器到存储控制器）。另外一种是72个引脚的单列直插存储器模块，32位为块传送数据。

3. **增强的DRAM**，何谓增强？即对传统的DRAM在读写方面进行改进。主要有一下几种：

   (1). 快页模式（FPM DRAM）：传统的DRAM，RAS/CAS相对应，RAS发送一个地址，CAS接收地址的数据。FPM DRAM会从行缓冲区直接寻找数据，因此较传统的DRAM比较快。

   (2). DDR SDRAM，双倍数据速率同步DRAM，使用两个时钟作为控制信号，从而使DRAM速度翻倍。有DDR,DDR2，DDR3之分。

4. 其他类型的DRAM增强。

5. Intel Core i7只支持DDR3 SDRAM。

以上讨论均为易失性存储器，断电，数据即丢失。

下面讨论**非易失性存储器ROM**

ROM:只读存储器，read only memory，断电数据可以保存，主要分为以下几种：

1. PROM，可编程ROM，只能被编程一次，熔丝机制。
2. EPROM，可擦除ROM。
3. 基于EEPROM（电子可擦除ROM）的闪存是一种重要的存储技术。基于闪存技术，产生基于内存的磁盘驱动器SSD，即固态硬盘。
4. 固件：存储在ROM设备中的程序。BIOS例程就属于固件。

访问主存：数据流通过**总线**来来回回。

I/O桥，进行信号翻译的装置，可以将系统总线的信号（CPU产生的信号），翻译成存储器总线上的信号，也可以将存储器总线上的信号翻译成系统总线上的信号；后面我们可以看到I/O设备总线的信号也可以经过I/O桥进行翻译。示意如图：

![](C:\Users\huang_bin\Pictures\lovewallpaper\总线.png)

磁盘存储

访问旋转磁盘，主要耗费时间为寻道时间和旋转时间。寻找物理扇区的三元组（盘面，磁道，扇区），三元组唯一地标识了对应的物理扇区。



在磁盘可以存储数据之前，他必须被磁盘控制器格式化。包括用标识扇区的信息填写扇区之间的缝隙等等。又因为存在一些备用柱面，所以磁盘制造商所说的格式化容量比最大容量小。

**连接到I/O设备**

通用串行总线（USB）：2.0为60MB/s,3.0为600MB/s。

图形卡：即显卡。

主机总线适配器：将一个或者多个磁盘连接到I/O总线，使用的是一个特别的主机总线接口定义的通信协议。两个最常用的磁盘接口为SATA和SCSI。SCSI更快更贵，SCSI可以连接多个磁盘驱动器，SATA只能连接一个。



**访问磁盘**

CPU使用存储器映射I/O的技术来向I/O设备发出命令。在使用该项技术的系统中，地址空间有一块地址是I/O设备通信保留的。每个这样的地址称为一个I/O端口。当一个I/O设备连接到总线时，它与一个或多个端口相关联（或它被映射到一个或者多个端口）。

**DMA**

磁盘控制器收到CPU的读命令之后，将CPU传送过来的逻辑块号翻译成一个扇区地址，读该扇区的内容，然后将内容直接传送到主存，不需要CPU的干涉。设备可以自己执行读或者写总线事务，而不需要CPU干涉的过程，称为直接存储器访问。这种数据传送称为DMA传送。DMA完成后，磁盘控制器传送给CPU一个中断信号。基本思想是，中断会发信号到CPU芯片的一个外部引脚上，这会导致CPU暂停它当前的工作，跳转到一个操作系统例程。这个程序会记录下I/O已经完成，然后将控制返回到CPU被中断的地方。

**固态硬盘**

固态硬盘基于闪存技术（电子可编程可擦除ROM，EEPROM），一个SSD由一个或者多个闪存芯片和内存翻译层组成。闪存芯片替代传统旋转磁盘中的机械驱动器，闪存翻译器则是一个硬件/固件设备，相当于磁盘控制器，将逻辑块的请求翻译成对底层物理设备的访问。

处理器功耗：P=fCv^2^，f为时钟频率，C为电容，与面积大致成正比，v是电压。

**局部性**

一个编写良好的计算机程序常常具有良好的局部性。

局部性的两种形式：时间局部性和空间局部性

局部性的应用：

1. 硬件层，局部性允许计算机设计者通过引入称为高速缓存存储器的小而快速的存储设备来保存最近被引用的指令和数据项，从而提高对主存的访问速度。
2. 操作系统级，允许系统将主存作为虚拟地址空间最近被引用块的高速缓存。
3. 应用程序级，Web浏览器将最近被引用的文档放在本地磁盘上。

代码区别与数据的一个重要属性是，运行时他是不能被修改的。

局部性小结：

1. 重复引用同一个变量的应用程序有良好的时间局部性。
2. 具有步长为k的引用模式的程序，步长越小，空间局部性越好。
3. 对于取指令来说，循环有良好的时间和空间局部性。循环体越小，内部循环迭代次数越多，局部性越好。



### 2. 存储器层次结构

存储器层级结构的本质：每一层存储设备都是较低一层的缓存，

**缓存管理**：

L1，L2，L3的缓存由内置在缓存中的硬件逻辑来管理。

DRAM主存由操作系统软件和CPU上的地址翻译硬件共同管理。

网络分布式系统由运行在本地机器上的客户端进行管理。

### 3. 高速缓存存储器

高速缓存的结构用元组（S,E,B,m）来描述。S为组数，E为每组内的高速缓存行行数，B为块大小，m为地址长度（位数）。

高速缓存取出被请求的字的过程：组选择，行匹配，字抽取。

如果E==1，那么称为直接映射高速缓存。如果S==1，称为全相联高速缓存，全相联高速缓存很昂贵，只适合做小的高速缓存，例如虚拟存储器的翻译备用缓冲器TLB。

为什么用中间的位来做索引？

答：缩短高速缓存器的预热过程。例如访问连续四个块，以高位来索引，这四个块都会被填充进第一个组，以四组高速缓存为例，余下的三组就被浪费了。如果以中间位进行索引，那么访问前四个块的时候，整个高速缓存就能够很快被充满。

**未命中时的缓存行替换策略**

1. LFU，最不常使用

2. LRU，最近最少使用

3. 其他

   以上，均需要额外的硬件和时间支持。

### 一个真实的高速缓存层次结构的解剖

Intel Core i7:

高速缓存既保存指令也保存数据。保存指令的cache称为i-cache，保存数据的cache称为d-cache。这样可以防止数据和指令发送冲突不命中。另一方面，由于i-cache通常是只读的，因此比较简单，可以针对数据和指令他们各自特点进行优化。这样划分的代价就是，可能会引起容量不命中增加。

以Core i7为例，其L1层分为i-cache和d-cache，核独有。L2层缓存为同一的高速缓存，核独有；L3为所有核共享的高速缓存。L1和L2是8路组相联，L3高速缓存是16路组相联。



